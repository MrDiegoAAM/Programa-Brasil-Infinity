import { ReactNode, createContext, useState, useEffect } from "react";
import { IRegisterPerson } from "../../pages/DashBoard/DashBoard";
import api from "../../server/api";
import { toast } from "react-toastify";
import { useNavigate } from "react-router-dom";
import jwt from "jsonwebtoken";
import { useAuth } from "./SupabaseAuthContext";
import { useData } from "./DataContext";

interface IHomelessProps {
  img: string;
  name: string;
  CPF: number;
  age: number;
  state: string;
  lastLocation: string;
  contact: number;
}

interface IUser {
  name: string;
  cnpj: string;
  adress: string;
  contact: string;
  email: string;
  password: string;
  picture: string;
}

interface IUserConstext {
  user: IUser | any;
  setUser: React.Dispatch<React.SetStateAction<any>>;
  isLogin: boolean;
  setIsLogin: React.Dispatch<React.SetStateAction<boolean>>;
  isAbrigado: boolean;
  setIsAbrigado: React.Dispatch<React.SetStateAction<boolean>>;
  isInstitution: boolean;
  setIsInstitution: React.Dispatch<React.SetStateAction<boolean>>;
  token: string | null;
  logout(): void;
  loadUserProfile(): void;
  isModal: boolean;
  homeLess: IRegisterPerson[];
  searchFor: string;
  isNextDisabled: boolean;
  isGoBackDisabled: boolean;
  isRegister: boolean;
  setHomeLess: React.Dispatch<React.SetStateAction<IRegisterPerson[]>>;
  setIsRegister: React.Dispatch<React.SetStateAction<boolean>>;
  setIsModal: React.Dispatch<React.SetStateAction<boolean>>;
  setSearchFor: React.Dispatch<React.SetStateAction<string>>;
  goBack(): void;
  next(): void;
  search(): void;
}

interface IChildrenProps {
  children: ReactNode;
}

const customId = "custom-id-yes";

export const AuthContext = createContext<IUserConstext>({} as IUserConstext);

export default function AuthProvider({ children }: IChildrenProps) {
  const [isLogin, setIsLogin] = useState(false);
  const [isModal, setIsModal] = useState(false);
  const [isRegister, setIsRegister] = useState(false);
  const [searchFor, setSearchFor] = useState("");
  const [nextPage, setNextPage] = useState(1);
  const [isNextDisabled, setIsNextDisabled] = useState(false);
  const [isGoBackDisabled, setIsGoBackDisabled] = useState(true);
  const [user, setUser] = useState({});
  const navigate = useNavigate();
  const [isInstitution, setIsInstitution] = useState(false);
  const [isAbrigado, setIsAbrigado] = useState(false);
  const [homeLess, setHomeLess] = useState<IRegisterPerson[]>([]);
  const [token, setToken] = useState<string | null>(null);
  
  // Integra√ß√£o com SupabaseAuthContext
  const { user: supabaseUser, session } = useAuth();
  const { userProfile } = useData();

  // Sincronizar estado de autentica√ß√£o do Supabase com AuthContext tradicional
  useEffect(() => {
    console.log("üîÑ Sincronizando estado de autentica√ß√£o do Supabase...");
    console.log("üë§ Usu√°rio Supabase:", supabaseUser ? "Logado" : "N√£o logado");
    console.log("üìã Perfil do usu√°rio:", userProfile);
    
    if (supabaseUser && userProfile) {
      console.log("‚úÖ Usu√°rio logado no Supabase, atualizando AuthContext tradicional...");
      setIsLogin(true);
      setUser(userProfile);
      
      // Determinar tipo de usu√°rio baseado no perfil
      if ('cnpj' in userProfile) {
        console.log("üè¢ Usu√°rio √© uma institui√ß√£o");
        setIsInstitution(true);
        setIsAbrigado(false);
      } else if ('cpf' in userProfile) {
        console.log("üë§ Usu√°rio √© um abrigado");
        setIsAbrigado(true);
        setIsInstitution(false);
      }
      
      // Simular token para compatibilidade com sistema antigo
      const mockToken = `supabase-${session?.access_token?.substring(0, 20) || 'mock'}`;
      setToken(mockToken);
      localStorage.setItem("@TOKEN", mockToken);
      localStorage.setItem("@type", 'cnpj' in userProfile ? "institution" : "abrigado");
      
    } else if (!supabaseUser) {
      console.log("‚ùå Usu√°rio n√£o logado no Supabase, limpando AuthContext tradicional...");
      setIsLogin(false);
      setUser({});
      setIsInstitution(false);
      setIsAbrigado(false);
      setToken(null);
      localStorage.removeItem("@TOKEN");
      localStorage.removeItem("@type");
    }
  }, [supabaseUser, userProfile, session]);

  const logout = () => {
    toast.success("Logout realizado com sucesso!", {
      autoClose: 1500,
      toastId: customId,
    });
    
    setTimeout(() => {
      localStorage.clear();
      setIsLogin(false);
      setIsAbrigado(false);
      setIsInstitution(false);
      setToken(null);
      setUser({
        id: "",
        name: "",
        email: "",
        telephone: "",
        address: "",
        cnpj: "",
        age: "",
        cpf: "",
        picture: "",
        search(): void {},
        logout(): void {}
      });
      delete api.defaults.headers.common.Authorization;
      navigate("/home", { replace: true });
    }, 2000);
  };

  // eslint-disable-next-line @typescript-eslint/no-unused-vars

  const clearAuthData = () => {
    console.log("Limpando dados de autentica√ß√£o...");
    localStorage.clear();
    setIsLogin(false);
    setToken(null);
    setIsAbrigado(false);
    setIsInstitution(false);
    setUser({});
    delete api.defaults.headers.common.Authorization;
  };

  const loadUserProfile = () => {
    console.log("üîÑ loadUserProfile chamado");
    const storedToken = localStorage.getItem("@TOKEN");
    const type = localStorage.getItem("@type");
    
    console.log("üìã Token armazenado:", storedToken ? "Existe" : "N√£o existe");
    console.log("üìã Tipo armazenado:", type);
    
    if (storedToken && type) {
      console.log(`üöÄ Carregando perfil do usu√°rio, tipo: ${type}`);
      setToken(storedToken);
      setIsLogin(true);
      api.defaults.headers.common.Authorization = `Bearer ${storedToken}`;
      console.log("üîë Authorization header configurado:", api.defaults.headers.common.Authorization);

      if (type === "abrigado") {
        console.log("üìû Fazendo requisi√ß√£o para /abrigados/profile");
        console.log("üåê URL base da API:", api.defaults.baseURL);
        console.log("üîó URL completa:", `${api.defaults.baseURL}/abrigados/profile`);
        api.get(`/abrigados/profile`).then((res) => {
          console.log("‚úÖ Perfil do abrigado carregado:", res.data);
          console.log("üñºÔ∏è Foto do abrigado:", res.data.picture);
          console.log("üîÑ Definindo isAbrigado como true");
          setIsAbrigado(true);
          setIsInstitution(false);
          setUser(res.data);
          toast.success("Perfil carregado com sucesso");
        }).catch((error) => {
          console.error("‚ùå Erro ao buscar perfil do abrigado:", error);
          console.error("‚ùå Detalhes do erro:", {
            message: error.message,
            response: error.response?.data,
            status: error.response?.status,
            config: error.config
          });
          
          // Fallback para dados mock quando Edge Functions n√£o funcionam
          if (storedToken.includes("mock-signature")) {
            console.log("üîÑ Usando dados mock para perfil do abrigado");
            const mockProfile = {
              id: 'test-123',
              name: 'Diego Teste',
              email: 'diegoaam@hotmail.com',
              age: 30,
              cpf: '123.456.789-00',
              rg: '12.345.678-9',
              birth_date: '1993-01-01',
              address: 'Endere√ßo de Teste',
              telephone: '(11) 99999-9999',
              picture: "",
              description: 'Usu√°rio de teste'
            };
            setIsAbrigado(true);
            setIsInstitution(false);
            setUser(mockProfile);
            console.log("‚úÖ Perfil mock carregado:", mockProfile);
            toast.success("Perfil carregado com sucesso (modo teste)");
          } else {
            // Se houver erro de autentica√ß√£o, limpar dados
            if (error.response?.status === 401 || error.response?.status === 403 || error.response?.status === 404) {
              console.log("üßπ Token inv√°lido ou usu√°rio n√£o encontrado, limpando dados...");
              clearAuthData();
              toast.error("Sess√£o expirada. Fa√ßa login novamente.");
            } else {
              console.log("‚ö†Ô∏è Erro n√£o relacionado √† autentica√ß√£o, mantendo dados...");
              toast.error("Erro ao carregar perfil. Tente novamente.");
            }
          }
        });
      } else if (type === "institution") {
        console.log("üìû Fazendo requisi√ß√£o para /register/institution/profile");
        api.get(`/register/institution/profile`).then((res) => {
          console.log("‚úÖ Perfil da institui√ß√£o carregado:", res.data);
          console.log("üñºÔ∏è Foto da institui√ß√£o:", res.data.picture);
          setIsInstitution(true);
          setIsAbrigado(false);
          setUser(res.data);
          toast.success("Perfil da institui√ß√£o carregado com sucesso");
          
          // Carregar abrigados da institui√ß√£o ap√≥s definir o tipo
          console.log("üîÑ Carregando abrigados da institui√ß√£o...");
          api.get("/homeless-by-institution").then((homelessRes) => {
            console.log("‚úÖ Abrigados da institui√ß√£o carregados:", homelessRes.data);
            setHomeLess(homelessRes.data);
          }).catch((homelessError) => {
            console.error("‚ùå Erro ao carregar abrigados da institui√ß√£o:", homelessError);
            
            // Fallback para dados mock quando Edge Functions n√£o funcionam
            if (storedToken.includes("mock-signature")) {
              console.log("üîÑ Usando dados mock para lista de abrigados");
              const mockHomeless = [
                {
                  id: 1,
                  name: "Jo√£o Silva",
                  age: 35,
                  cpf: "111.222.333-44",
                  telephone: "11999999999",
                  address: "Centro, S√£o Paulo - SP",
                  state: "SP",
                  lastLocation: "Centro",
                  contact: "11999999999",
                  img: null,
                  institution: "Institui√ß√£o Teste",
                  picture: ""
                },
                {
                  id: 2,
                  name: "Maria Santos",
                  age: 28,
                  cpf: "555.666.777-88",
                  telephone: "11888888888",
                  address: "Vila Madalena, S√£o Paulo - SP",
                  state: "SP",
                  lastLocation: "Vila Madalena",
                  contact: "11888888888",
                  img: null,
                  institution: "Institui√ß√£o Teste",
                  picture: ""
                }
              ];
              setHomeLess(mockHomeless);
              console.log("‚úÖ Abrigados mock carregados:", mockHomeless);
            } else {
              toast.error("Erro ao carregar abrigados");
            }
          });
        }).catch((error) => {
          console.error("‚ùå Erro ao buscar perfil da institui√ß√£o:", error);
          console.error("‚ùå Detalhes do erro:", {
            message: error.message,
            response: error.response?.data,
            status: error.response?.status,
            config: error.config
          });
          
          // Fallback para dados mock quando Edge Functions n√£o funcionam
          if (storedToken.includes("mock-signature")) {
            console.log("üîÑ Usando dados mock para perfil da institui√ß√£o");
            const mockProfile = {
              id: 'inst-123',
              name: 'Institui√ß√£o Teste',
              email: 'instituicao@teste.com',
              cnpj: '12.345.678/0001-90',
              address: 'Endere√ßo da Institui√ß√£o',
              telephone: '(11) 88888-8888',
              picture: "",
              description: 'Institui√ß√£o de teste'
            };
            setIsInstitution(true);
            setIsAbrigado(false);
            setUser(mockProfile);
            console.log("‚úÖ Perfil mock da institui√ß√£o carregado:", mockProfile);
            toast.success("Perfil da institui√ß√£o carregado com sucesso (modo teste)");
            
            // Carregar dados mock de abrigados
            const mockHomeless = [
               {
                 id: 1,
                 name: "Jo√£o Silva",
                 age: 35,
                 cpf: "111.222.333-44",
                 telephone: "11999999999",
                 address: "Centro, S√£o Paulo - SP",
                 state: "SP",
                 lastLocation: "Centro",
                 contact: "11999999999",
                 img: null,
                 institution: "Institui√ß√£o Teste",
                 picture: ""
               },
               {
                 id: 2,
                 name: "Maria Santos",
                 age: 28,
                 cpf: "555.666.777-88",
                 telephone: "11888888888",
                 address: "Vila Madalena, S√£o Paulo - SP",
                 state: "SP",
                 lastLocation: "Vila Madalena",
                 contact: "11888888888",
                 img: null,
                 institution: "Institui√ß√£o Teste",
                 picture: ""
               }
             ];
            setHomeLess(mockHomeless);
            console.log("‚úÖ Abrigados mock carregados:", mockHomeless);
          } else {
            // Se houver erro de autentica√ß√£o, limpar dados
            if (error.response?.status === 401 || error.response?.status === 403 || error.response?.status === 404) {
              console.log("üßπ Token inv√°lido ou institui√ß√£o n√£o encontrada, limpando dados...");
              clearAuthData();
              toast.error("Sess√£o expirada. Fa√ßa login novamente.");
            } else {
              console.log("‚ö†Ô∏è Erro n√£o relacionado √† autentica√ß√£o, mantendo dados...");
              toast.error("Erro ao carregar perfil. Tente novamente.");
            }
          }
        });
      }
    } else {
      console.log("‚ö†Ô∏è Token ou tipo n√£o encontrado no localStorage");
    }
  };

  // Inicializa√ß√£o do token e autentica√ß√£o
  useEffect(() => {
    console.log("üîÑ useEffect de inicializa√ß√£o executado");
    const storedToken = localStorage.getItem("@TOKEN");
    const type = localStorage.getItem("@type");
    
    console.log("üìã Token no useEffect:", storedToken ? "Existe" : "N√£o existe");
    console.log("üìã Tipo no useEffect:", type);
    
    if (storedToken && type) {
      console.log("‚úÖ Token encontrado na inicializa√ß√£o, carregando perfil...");
      loadUserProfile();
    } else {
      console.log("‚ö†Ô∏è Nenhum token encontrado na inicializa√ß√£o");
      setIsLogin(false);
      setToken(null);
      setIsAbrigado(false);
      setIsInstitution(false);
      setUser({});
    }
  }, []); // Executar apenas uma vez na inicializa√ß√£o

  function next() {
    api
      .get("database", {
        params: {
          _page: nextPage + 1,
          _limit: 8,
        },
      })
      .then((res) => {
        if (res.data.length > 0) {
          setNextPage(nextPage + 1);
        } else if (res.data.length < 0) {
          setIsNextDisabled(true);
        }
      });
    if (nextPage > 0) {
      setIsGoBackDisabled(false);
    }
  }

  function goBack() {
    api
      .get("database", {
        params: {
          _page: nextPage,
          _limit: 8,
        },
      })
      .then((res) => {
        if (nextPage <= 1) {
          setIsGoBackDisabled(false);
        } else if (nextPage > 1) {
          setIsGoBackDisabled(true);
          setIsNextDisabled(false);
        }
      });
    setNextPage(nextPage - 1);
  }

  function search() {
    const endpoint = isInstitution ? "/homeless-by-institution" : "/homeless";
    api.get(endpoint).then((res) => {
      console.log(res);
      setHomeLess([
        ...res.data.filter((item: any) => item.name.includes(searchFor)),
      ]);
    }).catch((error) => {
      console.error("Erro ao buscar abrigados:", error);
      toast.error("Erro ao carregar abrigados");
    });
  }

  useEffect(() => {
    // S√≥ buscar dados se estiver logado
    if (isLogin && token) {
      const endpoint = isInstitution ? "/homeless-by-institution" : "/homeless";
      api
        .get(endpoint)
        .then((res) => {
          console.log(`‚úÖ Dados carregados do endpoint ${endpoint}:`, res.data);
          setHomeLess(res.data);
        })
        .catch((error) => {
          console.error("Erro ao buscar dados dos abrigados:", error);
          toast.error("Erro ao carregar abrigados");
        });
    }
  }, [nextPage, isLogin, token, isInstitution]);

  return (
    <AuthContext.Provider
      value={{
        user,
        setUser,
        isLogin,
        setIsLogin,
        isAbrigado,
        setIsAbrigado,
        isInstitution,
        setIsInstitution,
        token,
        logout,
        loadUserProfile,
        isModal,
        homeLess,
        searchFor,
        isNextDisabled,
        isGoBackDisabled,
        isRegister,
        setHomeLess,
        setIsRegister,
        setIsModal,
        setSearchFor,
        goBack,
        next,
        search,
      }}
    >
      {children}
    </AuthContext.Provider>
  );
}
